import Foundation

struct Coord: Hashable {
    let x: Int
    let y: Int

    var down: Coord {
        Coord(x: x, y: y + 1)
    }

    var left: Coord {
        Coord(x: x - 1, y: y)
    }

    var right: Coord {
        Coord(x: x + 1, y: y)
    }
}

func startPosition(in map: [[Substring]]) -> Coord {
    let y = map.firstIndex(where: { $0.contains("S") })!
    let x = map[y].firstIndex(of: "S")!
    return Coord(x: x, y: y)
}

func isValid(_ coord: Coord, in map: [[Substring]]) -> Bool {
    coord.y >= 0 && coord.y < map.count && coord.x >= 0 && coord.x < map[coord.y].count
}

func isSplit(_ coord: Coord, in map: [[Substring]]) -> Bool {
    map[coord.y][coord.x] == "^"
}

func day07(_ input: String, manyWorlds: Bool) -> Int {
    let map = input.split(separator: "\n").map { $0.split(separator: "") }
    let start = startPosition(in: map)

    var splitsList = [Coord]()
    var splitsSet = Set<Coord>()
    var memo = [Coord: Int]()
    func dfs(_ coord: Coord) -> Int {
        let next = coord.down
        guard isValid(next, in: map) && !splitsSet.contains(next) else { return 0 }

        if let value = memo[coord] { return value }

        var res: Int
        if isSplit(next, in: map) {
            if manyWorlds {
                splitsList.append(next)
            } else {
                splitsSet.insert(next)
            }
            res = dfs(next.left) + dfs(next.right) + 1
        } else {
            res = dfs(next)
        }
        memo[coord] = res
        return res
    }
    
    let res = dfs(start)
    return manyWorlds ? (res + 1) : splitsSet.count
}

let input = """
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.^...^...................................................................
.............................................................................................................................................
..................................................................^.....^.^..................................................................
.............................................................................................................................................
.................................................................^.^...^.^.^.................................................................
.............................................................................................................................................
................................................................^.^...^.^...^................................................................
.............................................................................................................................................
...............................................................^...^.....^...^...............................................................
.............................................................................................................................................
..............................................................^...^...^.^.^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.....^.^.^.....^.............................................................
.............................................................................................................................................
............................................................^.^.^.^...^.^.^...^.^............................................................
.............................................................................................................................................
...........................................................^.......^.^.^.^.^...^.^...........................................................
.............................................................................................................................................
..........................................................^...^.^.^.^.^...^...^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^...^.^...^.....^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.^...^.^.^.^.^...^.^.....^.^........................................................
.............................................................................................................................................
.......................................................^.^.^.^.^.^.^.....^.^.^.....^.^.......................................................
.............................................................................................................................................
......................................................^.^.^...^.^.^.^.^.^.^.^.^.^.....^......................................................
.............................................................................................................................................
.....................................................^...............^.^.^.....^...^...^.....................................................
.............................................................................................................................................
....................................................^.^.^.....^.^...^.^.^.^.....^.^...^.^....................................................
.............................................................................................................................................
...................................................^.^...^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^...................................................
.............................................................................................................................................
..................................................^.^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^.^..................................................
.............................................................................................................................................
.................................................^.^...^.^.^.^.....^.^.^...^.^.^...^...^.^.^.................................................
.............................................................................................................................................
................................................^...^...^.^...^.^.^.^.^.^.....^.^...^.^...^.^................................................
.............................................................................................................................................
...............................................^.....^.....^.^.^...^.^.^.^.^.....^.^.^.......^...............................................
.............................................................................................................................................
..............................................^.^...^.^.^.^.^...^...^.^.....^...^.^.^.....^.^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.............................................
.............................................................................................................................................
............................................^.^.^.^...^.....^.^.^.^...^.^.^.^.^.^...^.^.^...^.^.^............................................
.............................................................................................................................................
...........................................^.^.^...^...^...^.^.^.^.^.^.....^...^.^.....^.^.....^.^...........................................
.............................................................................................................................................
..........................................^.....^.......^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.........^..........................................
.............................................................................................................................................
.........................................^.^...^.....^.^...^.^.^...^.^.^.^.......^.....^.^...^.^.^.^.........................................
.............................................................................................................................................
........................................^.^...^.^.^.^.^.^.^.......^.^.^...^.^.^...^.^.^.^...^.^...^.^........................................
.............................................................................................................................................
.......................................^...^...^.^.^.^.......^.^.^.^.^.^.^.^.^...^.^.....^...^.^...^.^.......................................
.............................................................................................................................................
......................................^.^...^.^.^...^.^.......^.........^...^...^.^...^.^...^.^.^.^...^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.......^.^.^...^.^.^.^.^...^.^...^...^.^...^.^.^.^.^...^.....................................
.............................................................................................................................................
....................................^.^.^...^.^.^.^.^.^.....^...^.^.^.^.^.^.^.....^.^.^.........^.....^.^....................................
.............................................................................................................................................
...................................^.^.^.^.....^.^.^.^.^.^.^...^.^.^.....^...^.......^.^.^.^.^.^.^...^.^.^...................................
.............................................................................................................................................
..................................^...^.^.^.^...^.^...^...^.^...^.^.^...^...^...^.^.....^.....^.^.^...^.^.^..................................
.............................................................................................................................................
.................................^.^...^.^.^...^.^...^.^.........^.^.^.^.^.^.^.^.^...^...^.^...^.^.^.^.^.^.^.................................
.............................................................................................................................................
................................^...^.^.^.^.^.^.^.^.^.....^...^.^.........^...^.^...^...^.....^.^.....^...^.^................................
.............................................................................................................................................
...............................^.^.^.^...^.^.........^.^.^.^.^.....^.^.....^.^...^.^.^.^.^...^.^.^.....^.^.^.^...............................
.............................................................................................................................................
..............................^.^.^.^...^.^.^.^.^.^.....^.^.^...^...^.^.^.^.^...^.......^.^.^.^.^...^.^.....^.^..............................
.............................................................................................................................................
.............................^.^...^...^.........^...^.....^.^.^.^.^.^.^.^...^...^...^.^.^.^.^.....^.^.....^...^.............................
.............................................................................................................................................
............................^.^.^.^...^...^.^...^.^.......^...^.^.^...^.^.^.^.^...^...^.^.......^.^.^...^.^.^.^.^............................
.............................................................................................................................................
...........................^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.^...^.^.^...^...^.^.^.^.^.^.....^...^.^.^.^.^.^...^...........................
.............................................................................................................................................
..........................^.....^.^.^.....^.^.......^.^...^...^.^.^...^.....^.^.^...^...^.^...^.^.^.^.^.^...^.^...^..........................
.............................................................................................................................................
.........................^.^.....^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^...^.^.....^.^...^.....^.^...^.^.........................
.............................................................................................................................................
........................^...^...^.^.^...^...........^.^...^.^.....^.^...^...^...^.....^.^.....^.^.^.........^.^...^.^........................
.............................................................................................................................................
.......................^.^.^.^...^.......^.^...^.^...^.^.^.....^.^.^.^.^.......^.^.^.^...^.^.....^.^.^.^...^.^.^.^...^.......................
.............................................................................................................................................
......................^.^.^.........^.^...^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^......................
.............................................................................................................................................
.....................^...^...^.^.^.^.....^...^.^...^.^.^...^.^.^...^.......^.^.^.^.^.^.^.^.^...^.^.....^...^.^.....^.^.^.....................
.............................................................................................................................................
....................^.^.^.^...^.^.^.^.^.^...^.^.^...^.....^...^...^.^...^.^.^.^...^.^.^.^.....^.^.^.^.....^...^.^.^.^...^....................
.............................................................................................................................................
...................^.......^.....^.^.^.^.^.^...^.^...^.^.^.....^...^...^.^.^.......^.^.^...^...^...^.^.^.....^.^.^...^.^.^...................
.............................................................................................................................................
..................^.^.^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.....^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.....^.^.....^.^..................
.............................................................................................................................................
.................^.^.^.^.^.^.^.^...^.^.^...^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^.....^.....^.^...^.^.^.^.^.....^.^.................
.............................................................................................................................................
................^.^...^.^.....^.^...^.^.^.....^...^...^.........^.^.^.^.^...^.^.^.^.....^.^.....^.^.....^.^.^.^.^.....^.^...^................
.............................................................................................................................................
...............^.^.....^.^...^.^...^.^.....^.^.^.^.^...^.^...^...^...^.^.^.^.^.^...^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...............
.............................................................................................................................................
..............^.^.....^.^.^...^.^.^.^...^.^.^.....^.^.^.^.^.^.^.^.^.^...^...^.^...^.^.......^...^.......^...^.^.....^.^.^...^.^..............
.............................................................................................................................................
.............^.^.^.^...^.....^.^.^.^.^...^...........^...^.^.^.^.....^.^.^.^.^...^...^.^.....^.^.^.^.^...^.^...^.^...^...^.....^.............
.............................................................................................................................................
............^.....^.^.^.^.^.^...^...^.^.^...^.^...^.^.^.^.^.^.^.^.....^.^.^.^.^.^...^.^.^.^...^.^...^.....^.....^.^.....^.^.^.^.^............
.............................................................................................................................................
...........^.^...^.^...^.^...^.^.^.....^.^.^.^...^.....^.^...^.....^.^.^...^.^.^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...........
.............................................................................................................................................
..........^.^.......^.^.^.....^...^.^...^.^.^.^...^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^.^.^.....^.^.^...^.^..........
.............................................................................................................................................
.........^.^.....^...^.^.^.^.^.^...^.....^.^.^.^.^.....^.^.^.^.^...^.......^...^.^.^.....^.^.^.^.^.^.^.^.^.^.....^.^...........^...^.........
.............................................................................................................................................
........^...^.......^.^.^.....^.^.^.^.^.^.^...^.....^...^.^.^.^.......^.^.^.........^...^...^.^...^.^.....^...^...^...^...^.....^...^........
.............................................................................................................................................
.......^...^.^.^...^...^.^.^.^...^...^.^.^...^.^.^.....^...^.^.^.^.......^.^...^.^.^.^.^...^...^.^.^...^.^.^...^.^.^.^.^.^...^...^...^.......
.............................................................................................................................................
......^.......^.......^.^.^.^.^.^...^.^...^.....^...^.^.^.^.^.^...^.^...^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^......
.............................................................................................................................................
.....^.^.....^.^.^.^...^.........^.^.^.^.^.^.^...^.^...^.^.^...^.....^...^.......^.^.^.^.^.......^.^.....^.^.^.^...^.^.^.^...^.^.......^.....
.............................................................................................................................................
....^.^.^.^...^.^.^.^.^.^...^...^.^.^.....^.....^...^.^.^.^.^.^.....^.^.....^.^.^...^.^.^.^.^.^.^.^.........^.^.......^.^...^.^.^.....^.^....
.............................................................................................................................................
...^.^.^.^.^.^.^...^...^.....^.^.^...^.^.^.^.^.^.^.^.....^.^...^...^.^.^.^.^...^.^...^.....^.^.^.^.^.^.^.^.^.^...^.^.......^.^...^.^...^.^...
.............................................................................................................................................
..^.^.^.^.^.^.^.^.......^...^.....^.^...^.^.^.^.^.^.^.^...^.....^.^.^.^...^.^.^.^...^...^.^.^.^.^.^.^.^.......^.^.^.....^.^...^.^.^...^...^..
.............................................................................................................................................
.^.^...^...^.^.^.^.....^.^.^.^.^...^.^...^.^.^...^.^.^.^.^.....^.^.......^.....^.....^...^...^.^.^.^.^...^.^...^.^...^.^.^.^.^.^.^...^.^...^.
.............................................................................................................................................
"""

print(day07(input, manyWorlds: false))
print(day07(input, manyWorlds: true))
